<center> <font face="黑体" size=10>Y86-64的流水线实现</font></center>

流水线寄存器按如下方式标号：

F 保存程序计数器的预测值。

D 位于取指和译码阶段之间。它保存关于最新取出的指令的信息，即将由译码阶段进行处理。

E 位于译码和执行阶段之间。它保存关于最新译码的指令和从寄存器文件读出的值的信息，即将由执行阶段进行处理。

M 位于执行和访存阶段之间。它保存最新执行的指令的结果，即将由访存阶段进行处理。它还保存关于用于处理条件转移的分支条件和分支目标的信息。

W 位于访存阶段和反馈路径之间，反馈路径将计算出来的值提供给寄存器文件写。而当完成ret指令时，它还要向PC选择逻辑提供返回地址。

流水线PIPE-：

![](D:\typora\page\StudyNote\深入理解计算机系统\img\PIPE-硬件结构.jpg)



当相邻指令间存在相关时会导致出现问题。这些相关有两种形式：

1) 数据相关，下一条指令会用到这一条指令计算出的结果；
2) 控制相关，一条指令要确定下一条指令的位置，例如在执行跳转、调用或返回指令时。

这些相关可能会导致流水线产生计算错误，称为冒险。同相关一样，冒险也可以分为两类：

1) 数据冒险
2) 控制冒险



流水线的最终实现PIPE：

![](D:\typora\page\StudyNote\深入理解计算机系统\img\流水线最终实现.jpg)

Y86-64指令体系有三种不同的内部产生的异常：

1) halt指令
2) 有非法指令和功能码组合的指令
3) 取指或数据读写试图访问一个非法地址

流水线控制逻辑必须处理以下4种情况：

1) ***加载/使用冒险：***在一条从内存中读出一个值的指令和一条使用该值得指令之间，流水线必须暂停一个周期。
2) ***处理ret：***流水线必须暂停直到ret指令到达写回阶段。
3) ***预测错误的分支：***在分支逻辑发现不应该选择分支之前，分支目标处的几条指令已经进入流水线了。必须取消这些指令，并从跳转指令后面的那条指令开始取指。
4) ***异常：***当一条指令导致异常，我们想要禁止后面的指令更新程序员可见状态，并且在异常指令到达写回阶段时，停止执行。
